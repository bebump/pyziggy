# emkyoot

Generate and run home automation projects written in Python. The `quicklaunch` subcommand will set up a minimal project in an empty directory. The next call to `quicklaunch` will refresh available device definitions, run some correctness checks using mypy and launch the project.

## Prerequisites

- Python 3.12+
- A working [zigbee2mqtt](https://www.zigbee2mqtt.io) instance.

## Quickstart

1) `pip install emkyoot`
2) Think about a `DIRECTORY` where you want to store your `config.toml` and `automation.py` files. These files will be autogenerated on the first run, if missing. You could also call `automation.py` anything else.
3) `emkyoot quicklaunch DIRECTORY/automation.py`

Follow the on-screen instructions. Everything, including the `automation.py` file will be autogenerated.

You can also find more information by issuing `emkyoot -h`.

## Debugging your automations

You can pass the `-v` or `--verbose` parameter to `quicklaunch` to set the logging level to `DEBUG`. For actual debugging with breakpoints and all, there are two options.

### Either import the command line interface in a Python script

This is the easiest way. Create a new source file in your project e.g. `run_automation.py` with the following content.

```
from emkyoot import emkyoot

emkyoot(["quicklaunch", "DIRECTORY/automation.py"])
```

This is the same function that's called by the `emkyoot` command line utility, so you need to pass it the same parameters. You can run this Python script in an IDE and use break points to observe your code.

The `run_automation.py` script must not import your automation in any other way and shouldn't contain an `AvailableDevices` object for reasons. So it's best to keep it lean.

### Or import the quicklaunch function anywhere and call it directly

It's possible to `from emkyoot import quicklaunch` anywhere, including your main `automation.py` file. You need to pass your `AvailableDevices` object directly to the `quicklaunch` function. E.g. you could add this block of code at the end of `automation.py`.

```
if __name__ == "__main__":
    from emkyoot import quicklaunch, EmkyootConfig

    config = EmkyootConfig.load("config.toml")

    if config is not None:
        quicklaunch(devices, config)  # devices is the AvailableDevices object
```

The advantage of the other approach is that it will regenerate your `AvailableDevices` object *before* instantiating it. The advantage of this approach, is that it doesn't require a separate `.py` script.

## Under the hood

This section is meant to provide some information that can help with understanding failure cases.

The automation file you pass to `quicklaunch` will be imported using `importlib` The imported module's dictionary will be scanned for a `DevicesClient` object. An `AvailableDevices` object meets this criteria because it inherits from `DevicesClient`. This object will be attached to a message loop and will carry out all communications with the MQTT server.

A consequence is that *you should only have one `AvailableDevices(DevicesClient)` object in your automation module*. The instantiation doesn't have to happen inside `automation.py`. You could do it in another module, and just import the object in `automation.py`. The important thing is that the AvailableDevices object must be visible through the module that you pass to `quicklaunch`.

